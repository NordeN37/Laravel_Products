!function(aV){var aN=function(a){var b=a,c=function(){return b};return{get:c,set:function(d){b=d},clone:function(){return aN(c())}}},aK=tinymce.util.Tools.resolve("tinymce.PluginManager"),bL=tinymce.util.Tools.resolve("tinymce.util.Tools"),a0=function(a){return function(){return a}};function bb(b){for(var c=[],a=1;a<arguments.length;a++){c[a-1]=arguments[a]}return function(){for(var d=[],f=0;f<arguments.length;f++){d[f]=arguments[f]}var g=c.concat(d);return b.apply(null,g)}}var a5,aT,aS,aJ,a8=a0(!1),aX=a0(!0),a4=a8,aL=aX,a6=function(){return a2},a2=(aJ={fold:function(a,b){return a()},is:a4,isSome:a4,isNone:aL,getOr:aS=function(a){return a},getOrThunk:aT=function(a){return a()},getOrDie:function(a){throw new Error(a||"error: getOrDie called on none.")},getOrNull:function(){return null},getOrUndefined:function(){return undefined},or:aS,orThunk:aT,map:a6,ap:a6,each:function(){},bind:a6,flatten:a6,exists:a4,forall:aL,filter:a6,equals:a5=function(a){return a.isNone()},equals_:a5,toArray:function(){return[]},toString:a0("none()")},Object.freeze&&Object.freeze(aJ),aJ),aR=function(f){var a=function(){return f},c=function(){return d},b=function(e){return e(f)},d={fold:function(g,h){return h(f)},is:function(e){return f===e},isSome:aL,isNone:a4,getOr:a,getOrThunk:a,getOrDie:a,getOrNull:a,getOrUndefined:a,or:c,orThunk:c,map:function(e){return aR(e(f))},ap:function(e){return e.fold(a6,function(g){return aR(g(f))})},each:function(e){e(f)},bind:b,flatten:a,exists:b,forall:b,filter:function(e){return e(f)?d:a2},equals:function(e){return e.is(f)},equals_:function(g,h){return g.fold(a4,function(e){return h(f,e)})},toArray:function(){return[f]},toString:function(){return"some("+f+")"}};return d},a3={some:aR,none:a6,from:function(a){return null===a||a===undefined?a2:aR(a)}};function aI(a,b){return ba(aV.document.createElement("canvas"),a,b)}function aD(a){var b=aI(a.width,a.height);return aF(b).drawImage(a,0,0),b}function aF(a){return a.getContext("2d")}function ba(a,b,c){return a.width=b,a.height=c,a}function aE(a){return a.naturalWidth||a.width}function aY(a){return a.naturalHeight||a.height}var bv=window.Promise?window.Promise:function(){var h=function(a){if("object"!=typeof this){throw new TypeError("Promises must be constructed via new")}if("function"!=typeof a){throw new TypeError("not a function")}this._state=null,this._value=null,this._deferreds=[],j(a,b(d,this),b(p,this))},q=h.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(a){aV.setTimeout(a,1)};function b(a,c){return function(){return a.apply(c,arguments)}}var e=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};function m(a){var c=this;null!==this._state?q(function(){var f=c._state?a.onFulfilled:a.onRejected;if(null!==f){var i;try{i=f(c._value)}catch(l){return void a.reject(l)}a.resolve(i)}else{(c._state?a.resolve:a.reject)(c._value)}}):this._deferreds.push(a)}function d(a){try{if(a===this){throw new TypeError("A promise cannot be resolved with itself.")}if(a&&("object"==typeof a||"function"==typeof a)){var c=a.then;if("function"==typeof c){return void j(b(c,a),b(d,this),b(p,this))}}this._state=!0,this._value=a,k.call(this)}catch(f){p.call(this,f)}}function p(a){this._state=!1,this._value=a,k.call(this)}function k(){for(var a=0,c=this._deferreds;a<c.length;a++){var f=c[a];m.call(this,f)}this._deferreds=[]}function g(a,f,i,c){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof f?f:null,this.resolve=i,this.reject=c}function j(a,f,l){var c=!1;try{a(function(n){c||(c=!0,f(n))},function(n){c||(c=!0,l(n))})}catch(i){if(c){return}c=!0,l(i)}}return h.prototype["catch"]=function(a){return this.then(null,a)},h.prototype.then=function(f,a){var c=this;return new h(function(i,l){m.call(c,new g(f,a,i,l))})},h.all=function(){for(var a=[],f=0;f<arguments.length;f++){a[f]=arguments[f]}var i=Array.prototype.slice.call(1===a.length&&e(a[0])?a[0]:a);return new h(function(s,r){if(0===i.length){return s([])}var c=i.length;function l(v,o){try{if(o&&("object"==typeof o||"function"==typeof o)){var w=o.then;if("function"==typeof w){return void w.call(o,function(x){l(v,x)},r)}}i[v]=o,0==--c&&s(i)}catch(u){r(u)}}for(var n=0;n<i.length;n++){l(n,i[n])}})},h.resolve=function(a){return a&&"object"==typeof a&&a.constructor===h?a:new h(function(c){c(a)})},h.reject=function(a){return new h(function(c,f){f(a)})},h.race=function(a){return new h(function(c,i){for(var l=0,f=a;l<f.length;l++){f[l].then(c,i)}})},h}();function bI(a){var b,c=a.src;return 0===c.indexOf("data:")?bp(c):(b=c,new bv(function(d,g){var f=new aV.XMLHttpRequest;f.open("GET",b,!0),f.responseType="blob",f.onload=function(){200===this.status&&d(this.response)},f.onerror=function(){var h,i=this;g(0===this.status?((h=new Error("No access to download image")).code=18,h.name="SecurityError",h):new Error("Error "+i.status+" downloading image"))},f.send()}))}function bD(a){return new bv(function(d,g){var j=aV.URL.createObjectURL(a),f=new aV.Image,h=function(){f.removeEventListener("load",c),f.removeEventListener("error",b)};function c(){h(),d(f)}function b(){h(),g("Unable to load data of type "+a.type+": "+j)}f.addEventListener("load",c),f.addEventListener("error",b),f.src=j,f.complete&&c()})}function bp(a){return new bv(function(b,c){(function(D){var y=D.split(","),m=/data:([^;]+)/.exec(y[0]);if(!m){return a3.none()}for(var g=m[1],k=y[1],v=aV.atob(k),B=v.length,C=Math.ceil(B/1024),A=new Array(C),q=0;q<C;++q){for(var x=1024*q,E=Math.min(x+1024,B),z=new Array(E-x),w=x,j=0;w<E;++j,++w){z[j]=v[w].charCodeAt(0)}A[q]=new Uint8Array(z)}return a3.some(new aV.Blob(A,{type:g}))})(a).fold(function(){c("uri is not base64: "+a)},b)})}function bo(a,b,c){return b=b||"image/png",aV.HTMLCanvasElement.prototype.toBlob?new bv(function(d,f){a.toBlob(function(e){e?d(e):f()},b,c)}):bp(a.toDataURL(b,c))}function bQ(a){return bD(a).then(function(b){var c;c=b,aV.URL.revokeObjectURL(c.src);var d=aI(aE(b),aY(b));return aF(d).drawImage(b,0,0),d})}function bT(a,c,f){var b=c.type;function d(e,g){return a.then(function(h){return j=g,i=(i=e)||"image/png",h.toDataURL(i,j);var i,j})}return{getType:a0(b),toBlob:function(){return bv.resolve(c)},toDataURL:function(){return f},toBase64:function(){return f.split(",")[1]},toAdjustedBlob:function(g,h){return a.then(function(e){return bo(e,g,h)})},toAdjustedDataURL:d,toAdjustedBase64:function(g,h){return d(g,h).then(function(e){return e.split(",")[1]})},toCanvas:function(){return a.then(aD)}}}function bN(a){return(b=a,new bv(function(c){var d=new aV.FileReader;d.onloadend=function(){c(d.result)},d.readAsDataURL(b)})).then(function(c){return bT(bQ(a),a,c)});var b}function by(b,a){return bo(b,a).then(function(c){return bT(bv.resolve(b),c,b.toDataURL())})}function bc(a,c,d){var b="string"==typeof a?parseFloat(a):a;return d<b?b=d:b<c&&(b=c),b}var aZ=[0,0.01,0.02,0.04,0.05,0.06,0.07,0.08,0.1,0.11,0.12,0.14,0.15,0.16,0.17,0.18,0.2,0.21,0.22,0.24,0.25,0.27,0.28,0.3,0.32,0.34,0.36,0.38,0.4,0.42,0.44,0.46,0.48,0.5,0.53,0.56,0.59,0.62,0.65,0.68,0.71,0.74,0.77,0.8,0.83,0.86,0.89,0.92,0.95,0.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10];function aC(f,h){for(var k,g=[],j=new Array(25),d=0;d<5;d++){for(var b=0;b<5;b++){g[b]=h[b+5*d]}for(b=0;b<5;b++){for(var c=k=0;c<5;c++){k+=f[b+5*c]*g[c]}j[b+5*d]=k}}return j}function bE(a,b){return b=bc(b,0,1),a.map(function(c,d){return d%6==0?c=1-(1-c)*b:c*=b,bc(c,0,1)})}function bS(b,c){return b.toCanvas().then(function(d){return g=d,j=b.getType(),f=c,h=aF(g),a=function(J,ae){for(var P,L,O,W,ce=J.data,H=ae[0],be=ae[1],S=ae[2],Z=ae[3],K=ae[4],at=ae[5],X=ae[6],N=ae[7],Q=ae[8],Y=ae[9],G=ae[10],C=ae[11],F=ae[12],bt=ae[13],E=ae[14],V=ae[15],A=ae[16],D=ae[17],B=ae[18],z=ae[19],q=0;q<ce.length;q+=4){P=ce[q],L=ce[q+1],O=ce[q+2],W=ce[q+3],ce[q]=P*H+L*be+O*S+W*Z+K,ce[q+1]=P*at+L*X+O*N+W*Q+Y,ce[q+2]=P*G+L*C+O*F+W*bt+E,ce[q+3]=P*V+L*A+O*D+W*B+z}return J}(h.getImageData(0,0,g.width,g.height),f),h.putImageData(a,0,0),by(g,j);var g,j,f,h,a})}function bs(a,b){return a.toCanvas().then(function(f){return h=f,k=a.getType(),g=b,j=aF(h),d=j.getImageData(0,0,h.width,h.height),c=j.getImageData(0,0,h.width,h.height),c=function(D,P,I){function F(i,l,m){return m<i?i=m:i<l&&(i=l),i}for(var H=Math.round(Math.sqrt(I.length)),L=Math.floor(H/2),T=D.data,C=P.data,R=D.width,K=D.height,O=0;O<K;O++){for(var E=0;E<R;E++){for(var Q=0,M=0,G=0,J=0;J<H;J++){for(var N=0;N<H;N++){var B=F(E+N-L,0,R-1),q=F(O+J-L,0,K-1),A=4*(q*R+B),S=I[J*H+N];Q+=T[A]*S,M+=T[A+1]*S,G+=T[A+2]*S}}var z=4*(O*R+E);C[z]=F(Q,0,255),C[z+1]=F(M,0,255),C[z+2]=F(G,0,255)}}return P}(d,c,g),j.putImageData(c,0,0),by(h,k);var h,k,g,j,d,c})}function bx(a){return function(b,c){return b.toCanvas().then(function(d){return function(h,k,m){for(var j=aF(h),l=new Array(256),g=0;g<l.length;g++){l[g]=a(g,m)}var f=function(i,p){for(var q=i.data,o=0;o<q.length;o+=4){q[o]=p[q[o]],q[o+1]=p[q[o+1]],q[o+2]=p[q[o+2]]}return i}(j.getImageData(0,0,h.width,h.height),l);return j.putImageData(f,0,0),by(h,k)}(d,b.getType(),c)})}}function bK(a){return function(b,c){return bS(b,a([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],c))}}function bP(a){return function(b){return bs(b,a)}}var bM,bn=(bM=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0,0,0,0,0,1],function(a){return bS(a,bM)}),bl=bK(function(a,b){return aC(a,[1,0,0,0,b=bc(255*b,-255,255),0,1,0,0,b,0,0,1,0,b,0,0,0,1,0,0,0,0,0,1])}),bB=bK(function(d,g){g=bc(g,-180,180)/180*Math.PI;var j=Math.cos(g),f=Math.sin(g),h=0.213,c=0.715,b=0.072;return aC(d,[h+0.787*j+f*-h,c+j*-c+f*-c,b+j*-b+0.928*f,0,0,h+j*-h+0.143*f,c+j*(1-c)+0.14*f,b+j*-b+-0.283*f,0,0,h+j*-h+-0.787*f,c+j*-c+f*c,b+0.928*j+f*b,0,0,0,0,0,1,0,0,0,0,0,1])}),aQ=bK(function(a,b){var c=1+(0<(b=bc(b,-1,1))?3*b:b);return aC(a,[0.3086*(1-c)+c,0.6094*(1-c),0.082*(1-c),0,0,0.3086*(1-c),0.6094*(1-c)+c,0.082*(1-c),0,0,0.3086*(1-c),0.6094*(1-c),0.082*(1-c)+c,0,0,0,0,0,1,0,0,0,0,0,1])}),b8=bK(function(a,b){var c;return b=bc(b,-1,1),aC(a,[(c=(b*=100)<0?127+b/100*127:127*(c=0==(c=b%1)?aZ[b]:aZ[Math.floor(b)]*(1-c)+aZ[Math.floor(b)+1]*c)+127)/127,0,0,0,0.5*(127-c),0,c/127,0,0,0.5*(127-c),0,0,c/127,0,0.5*(127-c),0,0,0,1,0,0,0,0,0,1])}),bj=bK(function(a,b){return aC(a,bE([0.33,0.34,0.33,0,0,0.33,0.34,0.33,0,0,0.33,0.34,0.33,0,0,0,0,0,1,0,0,0,0,0,1],b=bc(b,0,1)))}),bh=bK(function(a,b){return aC(a,bE([0.393,0.769,0.189,0,0,0.349,0.686,0.168,0,0,0.272,0.534,0.131,0,0,0,0,0,1,0,0,0,0,0,1],b=bc(b,0,1)))}),bF=function(b,d,g,c){return bS(b,(f=g,a=c,aC([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],[bc(d,0,2),0,0,0,0,0,f=bc(f,0,2),0,0,0,0,0,a=bc(a,0,2),0,0,0,0,0,1,0,0,0,0,0,1])));var f,a},bG=bP([0,-1,0,-1,5,-1,0,-1,0]),bg=bP([-2,-1,0,-1,1,1,0,1,2]),bw=bx(function(a,b){return 255*Math.pow(a/255,1-b)}),br=bx(function(a,b){return 255*(1-Math.exp(-a/255*b))});function cr(w,m,g){var b=aE(w),d=aY(w),j=m/b,q=g/d,v=!1;(j<0.5||2<j)&&(j=j<0.5?0.5:2,v=!0),(q<0.5||2<q)&&(q=q<0.5?0.5:2,v=!0);var p,h,k,x=(p=w,h=j,k=q,new bv(function(l){var u=aE(p),z=aY(p),s=Math.floor(u*h),y=Math.floor(z*k),f=aI(s,y),c=aF(f);c.drawImage(p,0,0,u,z,0,0,s,y),l(f)}));return v?x.then(function(a){return cr(a,m,g)}):x}function bi(b,a){return b.toCanvas().then(function(g){return j=g,l=b.getType(),h=a,k=aI(j.width,j.height),f=aF(k),90!==(h=h<(d=c=0)?360+h:h)&&270!==h||ba(k,k.height,k.width),90!==h&&180!==h||(c=k.width),270!==h&&180!==h||(d=k.height),f.translate(c,d),f.rotate(h*Math.PI/180),f.drawImage(j,0,0),by(k,l);var j,l,h,k,f,c,d})}function cg(b,c){return b.toCanvas().then(function(d){return g=d,j=b.getType(),f=c,h=aI(g.width,g.height),a=aF(h),"v"===f?(a.scale(1,-1),a.drawImage(g,0,-h.height)):(a.scale(-1,1),a.drawImage(g,-h.width,0)),by(h,j);var g,j,f,h,a})}function aG(d,e,h,b,g){return d.toCanvas().then(function(c){return j=c,l=d.getType(),f=e,k=h,aF(a=aI(b,g)).drawImage(j,-f,-k),by(a,l);var j,l,f,k,a})}var aA=function(a){return bn(a)},bR=function(a){return bG(a)},aO=function(a){return bg(a)},az=function(a,b){return bw(a,b)},cd=function(a,b){return br(a,b)},cb=function(a,c,d,b){return bF(a,c,d,b)},b0=function(a,b){return bl(a,b)},am=function(a,b){return bB(a,b)},bd=function(a,b){return aQ(a,b)},ap=function(a,b){return b8(a,b)},bX=function(a,b){return bj(a,b)},bV=function(a,b){return bh(a,b)},au=function(a,b){return cg(a,b)},b3=function(a,c,f,b,d){return aG(a,c,f,b,d)},ag=function(b,d,g){return f=d,a=g,(c=b).toCanvas().then(function(e){return cr(e,f,a).then(function(h){return by(h,c.getType())})});var c,f,a},a9=function(a,b){return bi(a,b)},cj=function(a){return bN(a)},aa="undefined"!=typeof aV.window?aV.window:Function("return this;")(),ah=function(a,b){return function(c,f){for(var g=f!==undefined&&null!==f?f:aa,d=0;d<c.length&&g!==undefined&&null!==g;++d){g=g[c[d]]}return g}(a.split("."),b)},bk=function(a,b){var c=ah(a,b);if(c===undefined||null===c){throw new Error(a+" not available on this browser")}return c},ch=function(){return bk("URL")},b4={createObjectURL:function(a){return ch().createObjectURL(a)},revokeObjectURL:function(a){ch().revokeObjectURL(a)}},bC=tinymce.util.Tools.resolve("tinymce.util.Delay"),bf=tinymce.util.Tools.resolve("tinymce.util.Promise"),cc=tinymce.util.Tools.resolve("tinymce.util.URI"),ao=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),bu=tinymce.util.Tools.resolve("tinymce.ui.Factory"),cp=tinymce.util.Tools.resolve("tinymce.geom.Rect"),an=function(a){return new bf(function(b){var c=function(){a.removeEventListener("load",c),b(a)};a.complete?b(a):a.addEventListener("load",c)})},bA=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),ad=tinymce.util.Tools.resolve("tinymce.util.Observable"),bW=tinymce.util.Tools.resolve("tinymce.util.VK"),ck=0,aP={create:function(a){return new (bu.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(b){return arguments.length?(this.state.set("rect",b),this):this.state.get("rect")},imageSize:function(){var b=this.state.get("viewRect");return{w:b.w,h:b.h}},toggleCropRect:function(b){this.state.set("cropEnabled",b)},imageSrc:function(c){var d=this,b=new aV.Image;b.src=c,an(b).then(function(){var f,h,i=d.state.get("viewRect");if((h=d.$el.find("img"))[0]){h.replaceWith(b)}else{var g=aV.document.createElement("div");g.className="mce-imagepanel-bg",d.getEl().appendChild(g),d.getEl().appendChild(b)}f={x:0,y:0,w:b.naturalWidth,h:b.naturalHeight},d.state.set("viewRect",f),d.state.set("rect",cp.inflate(f,-20,-20)),i&&i.w===f.w&&i.h===f.h||d.zoomFit(),d.repaintImage(),d.fire("load")})},zoom:function(b){return arguments.length?(this.state.set("zoom",b),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var c,f,h,d,g,b;c=this.$el.find("img"),f=this.getEl().clientWidth,h=this.getEl().clientHeight,d=c[0].naturalWidth,g=c[0].naturalHeight,1<=(b=Math.min((f-10)/d,(h-10)/g))&&(b=1),this.zoom(b)},repaintImage:function(){var v,m,g,b,d,j,q,s,p,h,k;k=this.getEl(),p=this.zoom(),h=this.state.get("rect"),q=this.$el.find("img"),s=this.$el.find(".mce-imagepanel-bg"),d=k.offsetWidth,j=k.offsetHeight,g=q[0].naturalWidth*p,b=q[0].naturalHeight*p,v=Math.max(0,d/2-g/2),m=Math.max(0,j/2-b/2),q.css({left:v,top:m,width:g,height:b}),s.css({left:v,top:m,width:g,height:b}),this.cropRect&&(this.cropRect.setRect({x:h.x*p+v,y:h.y*p+m,w:h.w*p,h:h.h*p}),this.cropRect.setClampRect({x:v,y:m,w:g,h:b}),this.cropRect.setViewPortRect({x:0,y:0,w:d,h:j}))},bindStates:function(){var b=this;function c(d){b.cropRect=function(w,q,z,g,k){var G,D,F,x,A="mce-",E=A+"crid-"+ck++;function B(f,h){return{x:h.x-f.x,y:h.y-f.y,w:h.w,h:h.h}}function C(J,p,l,f){var h,m,H,I,s;h=p.x,m=p.y,H=p.w,I=p.h,h+=l*J.deltaX,m+=f*J.deltaY,(H+=l*J.deltaW)<20&&(H=20),(I+=f*J.deltaH)<20&&(I=20),s=w=cp.clamp({x:h,y:m,w:H,h:I},z,"move"===J.name),s=B(z,s),G.fire("updateRect",{rect:s}),v(s)}function y(h){function f(i,l){l.h<0&&(l.h=0),l.w<0&&(l.w=0),bA("#"+E+"-"+i,g).css({left:l.x,top:l.y,width:l.w,height:l.h})}bL.each(D,function(e){bA("#"+E+"-"+e.name,g).css({left:h.w*e.xMul+h.x,top:h.h*e.yMul+h.y})}),f("top",{x:q.x,y:q.y,w:q.w,h:h.y-q.y}),f("right",{x:h.x+h.w,y:h.y,w:q.w-h.x-h.w+q.x,h:h.h}),f("bottom",{x:q.x,y:h.y+h.h,w:q.w,h:q.h-h.y-h.h+q.y}),f("left",{x:q.x,y:h.y,w:h.x-q.x,h:h.h}),f("move",h)}function j(e){y(w=e)}function v(f){var h,i;j((h=z,{x:(i=f).x+h.x,y:i.y+h.y,w:i.w,h:i.h}))}return D=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],x=["top","right","bottom","left"],bA('<div id="'+E+'" class="'+A+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(g),bL.each(x,function(e){bA("#"+E,g).append('<div id="'+E+"-"+e+'"class="'+A+'croprect-block" style="display: none" data-mce-bogus="all">')}),bL.each(D,function(e){bA("#"+E,g).append('<div id="'+E+"-"+e.name+'" class="'+A+"croprect-handle "+A+"croprect-handle-"+e.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+e.label+'" aria-grabbed="false">')}),F=bL.map(D,function(f){var h;return new (bu.get("DragHelper"))(E,{document:g.ownerDocument,handle:E+"-"+f.name,start:function(){h=w},drag:function(e){C(f,h,e.deltaX,e.deltaY)}})}),y(w),bA(g).on("focusin focusout",function(e){bA(e.target).attr("aria-grabbed","focus"===e.type)}),bA(g).on("keydown",function(l){var h;function f(i,p,u,m,s){i.stopPropagation(),i.preventDefault(),C(h,u,m,s)}switch(bL.each(D,function(e){if(l.target.id===E+"-"+e.name){return h=e,!1}}),l.keyCode){case bW.LEFT:f(l,0,w,-10,0);break;case bW.RIGHT:f(l,0,w,10,0);break;case bW.UP:f(l,0,w,0,-10);break;case bW.DOWN:f(l,0,w,0,10);break;case bW.ENTER:case bW.SPACEBAR:l.preventDefault(),k()}}),G=bL.extend({toggleVisibility:function(f){var h;h=bL.map(D,function(e){return"#"+E+"-"+e.name}).concat(bL.map(x,function(e){return"#"+E+"-"+e})).join(","),f?bA(h,g).show():bA(h,g).hide()},setClampRect:function(e){z=e,y(w)},setRect:j,getInnerRect:function(){return B(z,w)},setInnerRect:v,setViewPortRect:function(e){q=e,y(w)},destroy:function(){bL.each(F,function(e){e.destroy()}),F=[]}},ad)}(d,b.state.get("viewRect"),b.state.get("viewRect"),b.getEl(),function(){b.fire("crop")}),b.cropRect.on("updateRect",function(f){var g=f.rect,h=b.zoom();g={x:Math.round(g.x/h),y:Math.round(g.y/h),w:Math.round(g.w/h),h:Math.round(g.h/h)},b.state.set("rect",g)}),b.on("remove",b.cropRect.destroy)}b.state.on("change:cropEnabled",function(d){b.cropRect.toggleVisibility(d.value),b.repaintImage()}),b.state.on("change:zoom",function(){b.repaintImage()}),b.state.on("change:rect",function(d){var f=d.value;b.cropRect||c(f),b.cropRect.setRect(f)})}}))(a)}};function bY(a){return{blob:a,url:b4.createObjectURL(a)}}function aB(a){a&&b4.revokeObjectURL(a.url)}function ab(a){bL.each(a,aB)}function aW(cV,c3,cK,cZ){var cJ,cQ,cM,c1,cP,cS,cY,cL,c0,cW,cO,cR,cX,cI,cF,cH,c2,cG,cT,be,cv,ct,ae,Z,cA,cC,cy,ce=function(){var d=[],b=-1;function a(){return 0<b}function c(){return -1!==b&&b<d.length-1}return{data:d,add:function(f){var g;return g=d.splice(++b),d.push(f),{state:f,removed:g}},undo:function(){if(a()){return d[--b]}},redo:function(){if(c()){return d[++b]}},canUndo:a,canRedo:c}}(),c4=function(a){return cV.rtl?a.reverse():a};function cU(a){var c,f,b,d;c=cJ.find("#w")[0],f=cJ.find("#h")[0],b=parseInt(c.value(),10),d=parseInt(f.value(),10),cJ.find("#constrain")[0].checked()&&Z&&cA&&b&&d&&("w"===a.control.settings.name?(d=Math.round(b*cC),f.value(d)):(b=Math.round(d*cy),c.value(b))),Z=b,cA=d}function cE(a){return Math.round(100*a)+"%"}function cu(){cJ.find("#undo").disabled(!ce.canUndo()),cJ.find("#redo").disabled(!ce.canRedo()),cJ.statusbar.find("#save").disabled(!ce.canUndo())}function cB(){cJ.find("#undo").disabled(!0),cJ.find("#redo").disabled(!0)}function at(a){a&&cL.imageSrc(a.url)}function bt(a){return function(){var b=bL.grep(ae,function(c){return c.settings.name!==a});bL.each(b,function(c){c.hide()}),a.show(),a.focus()}}function cw(a){at(c1=bY(a))}function cz(a){at(c3=bY(a)),ab(ce.add(c3).removed),cu()}function cx(){var a=cL.selection();cj(c3.blob).then(function(b){b3(b,a.x,a.y,a.w,a.h).then(cD).then(function(c){cz(c),K()})})}var Q=function(a){var b=[].slice.call(arguments,1);return function(){cj((c1||c3).blob).then(function(c){a.apply(this,[c].concat(b)).then(cD).then(cw)})}};function K(){at(c3),aB(c1),bt(cQ)(),cu()}function cs(){c1?(cz(c1.blob),K()):function a(b,c){c1?c():setTimeout(function(){0<b--?a(b,c):cV.windowManager.alert("Error: failed to apply image operation.")},10)}(100,cs)}function cN(a){return bu.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:a})}var cD=function(a){return a.toBlob()};function J(a,b){return cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:cs}])).hide().on("show",function(){cB(),cj(c3.blob).then(function(c){return b(c)}).then(cD).then(function(c){var d=bY(c);at(d),aB(c1),c1=d})})}function G(a,f,c,b,d){return cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(g){var h;h=g.value,cj(c3.blob).then(function(e){return f(e,h)}).then(cD).then(function(i){var j=bY(i);at(j),aB(c1),c1=j})},minValue:cV.rtl?d:b,maxValue:cV.rtl?b:d,value:c,previewFilter:cE},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:cs}])).hide().on("show",function(){this.find("slider").value(c),cB()})}cP=cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:cx}])).hide().on("show hide",function(a){cL.toggleCropRect("show"===a.type)}).on("show",cB),cS=cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:cU},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:cU},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(a){!0===a.control.value()&&(cC=cA/Z,cy=Z/cA)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",function(a){var b=parseInt(cJ.find("#w").value(),10),c=parseInt(cJ.find("#h").value(),10);a.preventDefault(),function(g){for(var d=[],h=1;h<arguments.length;h++){d[h-1]=arguments[h]}var f=[].slice.call(arguments,1);return function(){cj(c3.blob).then(function(e){g.apply(this,[e].concat(f)).then(cD).then(cz)})}}(ag,b,c)(),K()}).on("show",cB),cY=cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:Q(au,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:Q(au,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:Q(a9,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:Q(a9,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:cs}])).hide().on("show",cB),cO=J(0,aA),cT=J(0,bR),be=J(0,aO),cR=G(0,b0,0,-1,1),cX=G(0,am,180,0,360),cI=G(0,bd,0,-1,1),cF=G(0,ap,0,-1,1),cH=G(0,bX,0,0,1),c2=G(0,bV,0,0,1),cG=function(a,d){function c(){var h,i,g;h=cJ.find("#r")[0].value(),i=cJ.find("#g")[0].value(),g=cJ.find("#b")[0].value(),cj(c3.blob).then(function(e){return d(e,h,i,g)}).then(cD).then(function(j){var k=bY(j);at(k),aB(c1),c1=k})}var f=cV.rtl?2:0,b=cV.rtl?0:2;return cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:f,value:1,maxValue:b,ondragend:c,previewFilter:cE},{type:"slider",label:"G",name:"g",minValue:f,value:1,maxValue:b,ondragend:c,previewFilter:cE},{type:"slider",label:"B",name:"b",minValue:f,value:1,maxValue:b,ondragend:c,previewFilter:cE},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:cs}])).hide().on("show",function(){cJ.find("#r,#g,#b").value(1),cB()})}(0,cb),cv=G(0,az,0,-1,1),ct=G(0,cd,1,0,2),cM=cN(c4([{text:"Back",onclick:K},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:bt(cX)},{text:"saturate",icon:"saturate",onclick:bt(cI)},{text:"sepia",icon:"sepia",onclick:bt(c2)},{text:"emboss",icon:"emboss",onclick:bt(be)},{text:"exposure",icon:"exposure",onclick:bt(ct)},{type:"spacer",flex:1}])).hide(),cQ=cN(c4([{tooltip:"Crop",icon:"crop",onclick:bt(cP)},{tooltip:"Resize",icon:"resize2",onclick:bt(cS)},{tooltip:"Orientation",icon:"orientation",onclick:bt(cY)},{tooltip:"Brightness",icon:"sun",onclick:bt(cR)},{tooltip:"Sharpen",icon:"sharpen",onclick:bt(cT)},{tooltip:"Contrast",icon:"contrast",onclick:bt(cF)},{tooltip:"Color levels",icon:"drop",onclick:bt(cG)},{tooltip:"Gamma",icon:"gamma",onclick:bt(cv)},{tooltip:"Invert",icon:"invert",onclick:bt(cO)}])),cL=aP.create({flex:1,imageSrc:c3.url}),c0=bu.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){at(c3=ce.undo()),cu()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){at(c3=ce.redo()),cu()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var a=cL.zoom();a<2&&(a+=0.1),cL.zoom(a)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var a=cL.zoom();0.1<a&&(a-=0.1),cL.zoom(a)}}]}),cW=bu.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:c4([c0,cL])}),ae=[cQ,cP,cS,cY,cM,cO,cR,cX,cI,cF,cH,c2,cG,cT,be,cv,ct],(cJ=cV.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(ao.DOM.getViewPort().w,800),minHeight:Math.min(ao.DOM.getViewPort().h,650),title:"Edit image",items:ae.concat([cW]),buttons:c4([{text:"Save",name:"save",subtype:"primary",onclick:function(){cK(c3.blob),cJ.close()}},{text:"Cancel",onclick:"close"}])})).on("close",function(){cZ(),ab(ce.data),c1=ce=null}),ce.add(c3),cu(),cL.on("load",function(){Z=cL.imageSize().w,cA=cL.imageSize().h,cC=cA/Z,cy=Z/cA,cJ.find("#w").value(Z),cJ.find("#h").value(cA)}),cL.on("crop",cx)}var aw,b1={edit:function(b,a){return new bf(function(c,d){return a.toBlob().then(function(e){aW(b,bY(e),c,d)})})}},ac={getImageSize:function(a){var c,d;function b(e){return/^[0-9\.]+px$/.test(e)}return c=a.style.width,d=a.style.height,c||d?b(c)&&b(d)?{w:parseInt(c,10),h:parseInt(d,10)}:null:(c=a.width,d=a.height,c&&d?{w:parseInt(c,10),h:parseInt(d,10)}:null)},setImageSize:function(a,c){var d,b;c&&(d=a.style.width,b=a.style.height,(d||b)&&(a.style.width=c.w+"px",a.style.height=c.h+"px",a.removeAttribute("data-mce-style")),d=a.width,b=a.height,(d||b)&&(a.setAttribute("width",c.w),a.setAttribute("height",c.h)))},getNaturalImageSize:function(a){return{w:a.naturalWidth,h:a.naturalHeight}}},bm=(aw="function",function(a){return function(b){if(null===b){return"null"}var c=typeof b;return"object"===c&&(Array.prototype.isPrototypeOf(b)||b.constructor&&"Array"===b.constructor.name)?"array":"object"===c&&(String.prototype.isPrototypeOf(b)||b.constructor&&"String"===b.constructor.name)?"string":c}(a)===aw}),aj=(Array.prototype.slice,function(a,c){for(var f=0,b=a.length;f<b;f++){var d=a[f];if(c(d,f,a)){return a3.some(d)}}return a3.none()});bm(Array.from)&&Array.from;var cm=function(a){return null!==a&&a!==undefined},cf=function(a,b){var c;return c=b.reduce(function(d,f){return cm(d)?d[f]:undefined},a),cm(c)?c:null},aq=function(a){return new bf(function(c){var b=new (bk("FileReader"));b.onload=function(d){var f=d.target;c(f.result)},b.readAsText(a)})},aH=function(b,a,c){return new bf(function(d){var e;(e=new (bk("XMLHttpRequest"))).onreadystatechange=function(){4===e.readyState&&d({status:e.status,blob:this.response})},e.open("GET",b,!0),e.withCredentials=c,bL.each(a,function(f,g){e.setRequestHeader(g,f)}),e.responseType="blob",e.send()})},b6=function(a){var b;try{b=JSON.parse(a)}catch(c){}return b},av=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],bO=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],af=function(a){return"ImageProxy HTTP error: "+aj(av,function(b){return a===b.code}).fold(a0("Unknown ImageProxy error"),function(b){return b.message})},bH=function(a){var b=af(a);return bf.reject(b)},cn=function(a){return aj(bO,function(b){return b.type===a}).fold(a0("Unknown service error"),function(b){return b.message})},a1=function(a,b){return aq(b).then(function(c){var f,g,d=(f=b6(c),"ImageProxy Service error: "+((g=cf(f,["error","type"]))?cn(g):"Invalid JSON in service error message"));return bf.reject(d)})},aU=function(a,b){return 400===(c=a)||403===c||500===c?a1(0,b):bH(a);var c},bZ=bH,a7=function(b,d){var g,c,f,a={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":d};return aH((g=b,c=d,f=-1===g.indexOf("?")?"?":"&",/[?&]apiKey=/.test(g)||!c?g:g+f+"apiKey="+encodeURIComponent(c)),a,!1).then(function(e){return e.status<200||300<=e.status?aU(e.status,e.blob):bf.resolve(e.blob)})},aM=function(a,b,c){return b?a7(a,b):aH(a,{},c).then(function(d){return d.status<200||300<=d.status?bZ(d.status):bf.resolve(d.blob)})},cl=0,ci=function(a,b){a.notificationManager.open({text:b,type:"error"})},b7=function(a){return a.selection.getNode()},ar=function(a,b){var c=b.src;return 0===c.indexOf("data:")||0===c.indexOf("blob:")||new cc(c).host===a.documentBaseURI.host},bz=function(a,b){return -1!==bL.inArray(a.getParam("imagetools_cors_hosts",[],"string[]"),new cc(b.src).host)},ax=function(d,g){var j,f,h,c,b=g.src;return bz(d,g)?aM(g.src,null,(f=d,h=g,-1!==bL.inArray(f.getParam("imagetools_credentials_hosts",[],"string[]"),new cc(h.src).host))):ar(d,g)?bI(g):(b=d.getParam("imagetools_proxy"),b+=(-1===b.indexOf("?")?"?":"&")+"url="+encodeURIComponent(g.src),j=(c=d).getParam("api_key",c.getParam("imagetools_api_key","","string"),"string"),aM(b,j,!1))},b5=function(a){var b;return(b=a.editorUpload.blobCache.getByUri(b7(a).src))?bf.resolve(b.blob()):ax(a,b7(a))},b2=function(a){clearTimeout(a.get())},ay=function(h,a,e,b,g){return a.toBlob().then(function(j){var l,p,k,m,f,c,d;return k=h.editorUpload.blobCache,l=(f=b7(h)).src,h.getParam("images_reuse_filename",!1,"boolean")&&((m=k.getByUri(l))?(l=m.uri(),p=m.name()):(c=h,p=(d=l.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?c.dom.encode(d[1]):null)),m=k.create({id:"imagetools"+cl++,blob:j,base64:a.toBase64(),uri:l,name:p}),k.add(m),h.undoManager.transact(function(){h.$(f).on("load",function i(){var q,s,o;h.$(f).off("load",i),h.nodeChanged(),e?h.editorUpload.uploadImagesAuto():(b2(b),q=h,s=b,o=bC.setEditorTimeout(q,function(){q.editorUpload.uploadImagesAuto()},q.getParam("images_upload_timeout",30000,"number")),s.set(o))}),g&&h.$(f).attr({width:g.w,height:g.h}),h.$(f).attr({src:m.blobUri()}).removeAttr("data-mce-src")}),m})},b9=function(c,d,a,b){return function(){return c._scanForImages().then(bb(b5,c)).then(cj).then(a).then(function(e){return ay(c,e,!1,d,b)},function(e){ci(c,e)})}},ak=function(c,a,b){return function(){var d=ac.getImageSize(b7(c)),f=d?{w:d.h,h:d.w}:null;return b9(c,a,function(e){return a9(e,b)},f)()}},bq=function(a,b,c){return function(){return b9(a,b,function(d){return au(d,c)})()}},cq=function(b,a){return function(){var d=b7(b),c=ac.getNaturalImageSize(d),e=function(f){return new bf(function(h){var g;(g=f,bD(g)).then(function(i){var j=ac.getNaturalImageSize(i);c.w===j.w&&c.h===j.h||ac.getImageSize(d)&&ac.setImageSize(d,j),b4.revokeObjectURL(i.src),h(f)})})};b5(b).then(cj).then(bb(function(g,f){return b1.edit(g,f).then(e).then(cj).then(function(h){return ay(g,h,!0,a)},function(){})},b),function(f){ci(b,f)})}},ai=function(a,b){return a.dom.is(b,"img:not([data-mce-object],[data-mce-placeholder])")&&(ar(a,b)||bz(a,b)||a.settings.imagetools_proxy)},al=b2,bJ=function(b,a){bL.each({mceImageRotateLeft:ak(b,a,-90),mceImageRotateRight:ak(b,a,90),mceImageFlipVertical:bq(b,a,"v"),mceImageFlipHorizontal:bq(b,a,"h"),mceEditImage:cq(b,a)},function(c,d){b.addCommand(d,c)})},co=function(c,a,b){c.on("NodeChange",function(d){var f=b.get();f&&f.src!==d.element.src&&(al(a),c.editorUpload.uploadImagesAuto(),b.set(null)),ai(c,d.element)&&b.set(d.element)})},ca=function(a){a.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),a.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),a.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),a.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),a.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),a.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})},bU=function(a){a.addContextToolbar(bb(ai,a),a.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions"))};aK.add("imagetools",function(a){var b=aN(0),c=aN(null);bJ(a,b),ca(a),bU(a),co(a,b,c)})}(window);